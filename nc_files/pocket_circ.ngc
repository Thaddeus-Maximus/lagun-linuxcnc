o<pocket_circ> sub
	; x1, y1, d, stepover, zstart, zend, fincut, mode
	; #1  #2  #3     #4      #5     #6    #7      #8
	; modes:
	;  0: CCW, helical plunge
	;  1: CW,  helical plunge
	;  2: CCW, straight plunge
	;  3: CW,  straight plunge

	;G10 L0 ; re-read tool data
	G90	  ; absolute x,y,z
	G90.1 ; absolute i,j,k
	M101  ; enable Z-axis (M102 disables)
	G17   ; select XY plane for arcs

	o100 if [[#8 EQ 0] OR [#8 EQ 1]] ; helical plunge
		#<r> = [#5410*0.3]
		#<z_step>  = [#<r>*2*3.14*TAN[5]]

		G0 Z#5
		G0 X[#1+#<r>] Y[#2]

		; helical plunge
		#<z> = [#5-#<z_step>]
		o101 while [#<z> GT #6]
			o102 if [#8 EQ 0]
				G3 X[#1+#<r>] Y[#2] I[#1] J[#2] Z[#<z>] P1
			o102 else
				G2 X[#1+#<r>] Y[#2] I[#1] J[#2] Z[#<z>] P1
			o102 endif
			#<z> = [#<z> - #<z_step>]
		o101 endwhile

		; finish the helical plunge
		#<a> = [[#<z>-#6]/#5*360]
		o103 if [#8 EQ 0]
			G3 X[#1+COS[#<a>]*#<r>] Y[#2+SIN[#<a>]*#<r>] I[#1] J[#2] Z[#6]
			G3 X[#1+COS[#<a>]*#<r>] Y[#2+SIN[#<a>]*#<r>] I[#1] J[#2] Z[#6]
		o103 else
			G2 X[#1+COS[#<a>]*#<r>] Y[#2-SIN[#<a>]*#<r>] I[#1] J[#2] Z[#6]
			G2 X[#1+COS[#<a>]*#<r>] Y[#2-SIN[#<a>]*#<r>] I[#1] J[#2] Z[#6]
		o103 endif

	o100 elseif [[#8 EQ 2] OR [#8 EQ 3]] ; straight plunge
		#<r> = 0

		G0 Z#5
		G0 X[#1] Y[#2]
		G1 Z[#6]

	o100 endif

	; do the spiral :)
	#<r_base> = #<r>
	#<a_base> = #<a>
	o105 while [#<r> LT [[#3-#5410]/2-#7]]
		G1 X[#1+COS[#<a>]*#<r>] Y[#2+SIN[#<a>]*#<r>]
		#<a> = [#<a>+1] ; next angle
		#<r> = [#<r_base>+[#<a>-#<a_base>]/360*#4] ; compute the radius accordingly
	o105 endwhile

	; pre-finish cut
	o104 if [#7 GT 0.0]
		#<r> = [[#3-#5410]/2-#7]
		G1 X[#1+COS[#<a>]*#<r>] Y[#2+SIN[#<a>]*#<r>]
		G3 X[#1+COS[#<a>]*#<r>] Y[#2+SIN[#<a>]*#<r>] I[#1] J[#2]
	o104 endif

	; finish cut
	#<r> = [[#3-#5410]/2]
	G1 X[#1+COS[#<a>]*#<r>] Y[#2+SIN[#<a>]*#<r>]
	G3 X[#1+COS[#<a>]*#<r>] Y[#2+SIN[#<a>]*#<r>] I[#1] J[#2]


	#<r> = [[#3-#5410]/2*0.9]
	G1 X[#1+COS[#<a>]*#<r>] Y[#2+SIN[#<a>]*#<r>]
	G0 Z#5


o<pocket_circ> endsub

M2